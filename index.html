<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Audit de ConformitÃ© â€“ D2F Compliant</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://unpkg.com/docx@8.5.0/build/index.umd.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 2em; background-color: #f9f9f9; }
    h1, h2 { color: #222; }
    label { display: block; margin-top: 1em; font-weight: bold; }
    input, textarea, select {
      width: 100%; padding: 0.5em; margin-top: 0.2em;
      border-radius: 4px; border: 1px solid #bbb;
    }
    button {
      margin-top: 2em; padding: 0.75em 2em; background-color: #0066cc;
      color: white; border: none; border-radius: 4px; cursor: pointer;
    }
    .question-block, .identite {
      background-color: #fff; border-radius: 6px; margin-bottom: 2em;
      padding: 1em; border: 1px solid #ccc;
    }
    .attendu {
      font-size: 0.9em; color: #333; background-color: #eef;
      padding: 0.5em; margin-top: 0.5em; border-left: 4px solid #88a;
    }
  </style>
</head>
<body>
<script>
// const mdp = prompt("ğŸ”’ Authentification requise
// Entrez le mot de passe dâ€™accÃ¨s :");
// if (mdp !== "d2f2024") {
//   document.body.innerHTML = "<h1 style='color:red'>â›” AccÃ¨s refusÃ©</h1>";
//   throw new Error("AccÃ¨s refusÃ©");
// }
// }
</script>
<h1>Audit de ConformitÃ© â€“ D2F Compliant</h1>
<label for="langSwitch">ğŸŒ Langue / Language</label>
<select id="langSwitch" onchange="changerLangue(this.value)">
  <option value="fr">FranÃ§ais</option>
  <option value="en">English</option>
</select>
<p id="msgReset" style="color: green; font-weight: bold;"></p>
<div class="identite">
  <h2>ğŸ§¾ Informations sur l'entitÃ© auditÃ©e</h2>
  <label for="societe">Nom de la sociÃ©tÃ©</label>
  <input id="societe">
  <label for="adresse">Adresse</label>
  <input id="adresse">
  <label for="participants">Participants</label>
  <textarea id="participants"></textarea>
</div>
<div id="questionnaire"></div>
<button onclick="genererDOCX()">ğŸ“ Exporter le rapport Word</button>
<button onclick="genererPDF()">ğŸ“„ Exporter le rapport PDF</button>
<button onclick="reinitialiserFormulaire()">â™»ï¸ RÃ©initialiser le formulaire</button>
<button onclick="sauvegarderFormulaire()">ğŸ’¾ Sauvegarder</button>
<button onclick="restaurerFormulaire()">ğŸ” Restaurer</button>
<script>
const exigences_traduites = {
  fr: [
    ["UnicitÃ© des factures", "Chaque facture doit comporter un identifiant unique, non rÃ©utilisable, chronologique et sans rupture de sÃ©quence. RÃ©f. BOI-CF-COM-10-10-20-60."],
    ["Horodatage serveur sÃ©curisÃ©", "Les opÃ©rations doivent Ãªtre horodatÃ©es depuis une source fiable (NTP), stockÃ©es de maniÃ¨re inviolable. RÃ©f. Annexe 2 NF525."],
    ["ChaÃ®nage des journaux dâ€™Ã©vÃ©nements", "Chaque Ã©vÃ©nement du journal doit comporter le hash de lâ€™Ã©vÃ©nement prÃ©cÃ©dent (HMAC/SHA256 recommandÃ©)."],
    ["Archivage probant", "Archivage Ã  valeur probante selon la norme NF Z42-020 : intÃ©gritÃ©, lisibilitÃ©, disponibilitÃ©, traÃ§abilitÃ©."],
    ["Validation des exports fiscaux", "Tous les fichiers fiscaux (FEC, Factur-X) doivent Ãªtre valides au format XSD fourni par lâ€™administration."],
    ["AccÃ¨s auditeur sÃ©curisÃ©", "Un accÃ¨s en lecture seule aux donnÃ©es et journaux doit Ãªtre prÃ©vu pour lâ€™audit fiscal. RÃ©f. BOI-CF-COM-10-10-20-60."],
    ["Authentification forte", "L'accÃ¨s aux fonctions sensibles doit Ãªtre protÃ©gÃ© par MFA ou Ã©quivalent sÃ©curisÃ©. Conforme RGPD & ANSSI."],
    ["Mentions fiscales automatiques", "Les mentions obligatoires doivent Ãªtre gÃ©nÃ©rÃ©es automatiquement selon le type de document. RÃ©f. CGI art. 242 nonies A."],
    ["Conservation des journaux 6 ans", "Les journaux dâ€™Ã©vÃ©nements doivent Ãªtre conservÃ©s 6 ans et consultables sur demande."],
    ["TraÃ§abilitÃ© des paiements", "Chaque encaissement/acompte doit Ãªtre reliÃ© Ã  une facture et journalisÃ©."],
    ["Annulation/modification document", "Toute modification ou annulation doit Ãªtre tracÃ©e et justifiÃ©e avec timestamp. RÃ©f. NF525."],
    ["Suivi de cycle de vie", "Statuts initiaux, validÃ©s, annulÃ©s, avoirs doivent Ãªtre tracÃ©s et archivÃ©s."],
    ["Export structurÃ© interopÃ©rable", "Les formats de facture doivent respecter EN 16931 ou Factur-X. RÃ©f. BOI-TVA-DECLA-30-20-30."],
    ["Validation XSD et profil CIUS-FR", "Chaque facture doit Ãªtre conforme Ã  son profil syntaxique. CIUS-FR recommandÃ©."],
    ["ContrÃ´le des remises", "Les remises commerciales doivent Ãªtre justifiÃ©es, tracÃ©es et enregistrÃ©es."],
    ["Gestion des duplicatas", "La rÃ©Ã©dition dâ€™un document doit Ãªtre tracÃ©e et marquÃ©e comme duplicata."],
    ["Journalisation des accÃ¨s utilisateurs", "Chaque action utilisateur doit Ãªtre loguÃ©e avec date, heure, nature de lâ€™action."],
    ["NumÃ©rotation continue", "La numÃ©rotation des piÃ¨ces doit Ãªtre continue sans rupture, format paramÃ©trable."],
    ["Signature Ã©lectronique", "La signature Ã©lectronique qualifiÃ©e est recommandÃ©e pour les envois vers les PDP."],
    ["Archivage des annexes", "Les piÃ¨ces jointes (devis, bons, etc.) doivent Ãªtre associÃ©es Ã  la facture et archivÃ©es."],
    ["Mentions obligatoires facture (papier/Ã©lectronique)", "La facture doit contenir les mentions lÃ©gales prÃ©vues par lâ€™article 242 nonies A du CGI."],
    ["Respect format structurÃ© Factur-X/UBL", "Le fichier transmis doit respecter le profil minimum (BASIC WL ou CIUS-FR). RÃ©f. EN 16931."],
    ["Lien facture avec documents source", "Les rÃ©fÃ©rences aux documents dâ€™origine doivent Ãªtre prÃ©sentes : devis, commande (BT-17, BT-18)."],
    ["Journalisation Ã©mission + transmission", "Lâ€™Ã©mission et la transmission doivent Ãªtre enregistrÃ©es dans un journal dâ€™audit sÃ©curisÃ©."],
    ["Gestion des accusÃ©s PDP et rejets", "Les statuts â€˜dÃ©posÃ©eâ€™, â€˜rejetÃ©eâ€™, â€˜acceptÃ©eâ€™ doivent Ãªtre journalisÃ©s avec rÃ©ponse PDP."],
    ["Archivage probant chaÃ®nÃ©", "Les factures archivÃ©es doivent Ãªtre chaÃ®nÃ©es entre elles ou signÃ©es individuellement."],
    ["Mise Ã  jour CDAR", "Le SI doit pouvoir synchroniser les statuts CDAR (Cycle De Vie) avec les retours PDP."],
    ["Transmission conforme CIUS/CTC-FR", "Le format transmis doit respecter les spÃ©cifications CTC-FR ou CIUS-FR."],
    ["TraÃ§abilitÃ© multi-PDP", "Le systÃ¨me doit router les factures vers la bonne PDP selon identifiant client (SIRET, PEPPOL ID)."],
    ["RÃ©conciliation livraisons/statuts", "Le SI doit rapprocher les transmissions envoyÃ©es avec les statuts de rÃ©ception."]
  ],
  en: [
    ["Invoice uniqueness", "Each invoice must have a unique identifier, non-reusable, chronological, without gaps. Ref. BOI-CF-COM-10-10-20-60."],
    ["Secure server timestamping", "Operations must be timestamped from a trusted source (NTP), and stored securely. Ref. Annex 2 NF525."],
    ["Event journal chaining", "Each event in the log must contain the hash of the previous event (HMAC/SHA256 recommended)."],
    ["Probative archiving", "Archiving must comply with NF Z42-020 for integrity, readability, availability, traceability."],
    ["Validation of fiscal exports", "All fiscal files (FEC, Factur-X) must be valid against the XSD format provided by authorities."],
    ["Secure auditor access", "Read-only access must be available for auditors. Ref. BOI-CF-COM-10-10-20-60."],
    ["Strong authentication", "Access to sensitive functions must be protected by MFA or secure equivalent. RGPD & ANSSI compliant."],
    ["Automatic fiscal mentions", "Mandatory legal mentions must be generated based on the document type. Ref. CGI art. 242 nonies A."],
    ["Journal retention 6 years", "Event logs must be retained for 6 years and made available upon request."],
    ["Payment traceability", "Each payment or deposit must be linked to an invoice and logged."],
    ["Document cancellation/modification", "Any change or cancellation must be timestamped and justified. Ref. NF525."],
    ["Lifecycle tracking", "Initial, validated, cancelled and credited statuses must be recorded and archived."],
    ["Structured interoperable export", "Invoice formats must comply with EN 16931 or Factur-X. Ref. BOI-TVA-DECLA-30-20-30."],
    ["XSD validation and CIUS-FR profile", "Each invoice must match its syntax profile. CIUS-FR recommended."],
    ["Discount control", "Commercial discounts must be justified, logged, and recorded."],
    ["Duplicate handling", "Reissued documents must be logged and marked as duplicates."],
    ["User access logging", "All user actions must be logged with timestamp and action details."],
    ["Continuous numbering", "Document numbering must be continuous and gap-free. Format configurable."],
    ["Electronic signature", "Qualified e-signatures are recommended for PDP transmissions."],
    ["Annex archiving", "Attachments (quotes, orders) must be linked to the invoice and archived."],
    ["Mandatory invoice mentions (paper/electronic)", "Invoices must include the legal mentions listed in CGI art. 242 nonies A."],
    ["Structured format compliance (Factur-X/UBL)", "Transmitted files must meet the minimum profile (BASIC WL or CIUS-FR). Ref. EN 16931."],
    ["Invoice-to-source linkage", "Invoices must reference source documents: quotes, orders (BT-17, BT-18)."],
    ["Emission + transmission logging", "Emission and transmission must be recorded in a secure audit journal."],
    ["PDP acknowledgment and rejection handling", "Statuses like â€˜submittedâ€™, â€˜rejectedâ€™, â€˜acceptedâ€™ must be logged with PDP response."],
    ["Chained probative archiving", "Archived invoices must be either chained or individually signed."],
    ["CDAR updates", "The system must sync invoice lifecycle statuses (CDAR) with PDP feedback."],
    ["CTC-FR/CIUS transmission compliance", "Transmitted format must comply with CTC-FR or CIUS-FR specifications."],
    ["Multi-PDP routing", "The system must route invoices to the correct PDP based on customer ID (SIRET, PEPPOL ID)."],
    ["Delivery status reconciliation", "The system must reconcile transmitted invoices with their delivery statuses."]
  ]
};

function changerLangue(val) {
  localStorage.setItem('langue', val);
  location.reload();
}

function genererFormulaire() {
  window.lang = localStorage.getItem("langue") || 'fr';
  const exigences = exigences_traduites[window.lang];
  const qform = document.getElementById("questionnaire");
  qform.innerHTML = '';
  exigences.forEach((e, i) => {
    const bloc = document.createElement("div");
    bloc.className = "question-block";
    const h2 = document.createElement("h2");
    h2.textContent = `${i + 1}. ${e[0]}`;
    bloc.appendChild(h2);
    const attendu = document.createElement("div");
    attendu.className = "attendu";
    attendu.textContent = e[1];
    bloc.appendChild(attendu);
    const label1 = document.createElement("label");
    label1.textContent = window.lang === 'fr' ? 'RÃ©ponse' : 'Answer';
    bloc.appendChild(label1);
    const textarea1 = document.createElement("textarea");
    bloc.appendChild(textarea1);
    const label2 = document.createElement("label");
    label2.textContent = window.lang === 'fr' ? 'Preuve' : 'Evidence';
    bloc.appendChild(label2);
    const textarea2 = document.createElement("textarea");
    bloc.appendChild(textarea2);
    const drop = document.createElement("div");
    drop.className = "dropzone";
    drop.style.border = "2px dashed #aaa";
    drop.style.padding = "10px";
    drop.style.minHeight = "60px";
    drop.style.background = "#f0f8ff";
    drop.textContent = window.lang === 'fr' ? 'DÃ©posez ici une image' : 'Drop an image here';
    drop.ondrop = function(event) {
  event.preventDefault();
  const file = event.dataTransfer.files[0];
  const reader = new FileReader();

  if (file.type.startsWith('image/')) {
    reader.onload = function(e) {
      drop.innerHTML = "";
      const img = document.createElement("img");
      img.src = e.target.result;
      img.style.maxWidth = "100px";
      drop.appendChild(img);
      drop.dataset.image = e.target.result;
    };
    reader.readAsDataURL(file);
  } else if (file.type.startsWith('text/') || file.type === 'application/pdf') {
    reader.onload = function(e) {
      drop.textContent = e.target.result.slice(0, 500) + '...';
      drop.dataset.text = e.target.result;
    };
    reader.readAsText(file);
  } else {
    drop.textContent = "âŒ Format non supportÃ©";
  }
    };
    drop.ondragover = function(event) { event.preventDefault(); };
    bloc.appendChild(drop);
    const label3 = document.createElement("label");
    label3.textContent = window.lang === 'fr' ? 'ConformitÃ©' : 'Compliance';
    bloc.appendChild(label3);
    const select = document.createElement("select");
    ["", "âœ… Conforme", "âŒ Non Conforme", "âš ï¸ Partiellement Conforme"].forEach(opt => {
      const o = document.createElement("option");
      o.value = opt;
      o.textContent = opt;
      select.appendChild(o);
    });
    bloc.appendChild(select);
    qform.appendChild(bloc);
  });
}

window.addEventListener("DOMContentLoaded", () => {
  document.getElementById("langSwitch").value = localStorage.getItem("langue") || "fr";
  genererFormulaire();
});
function sauvegarderFormulaire() {
  const data = {
    societe: document.getElementById("societe").value,
    adresse: document.getElementById("adresse").value,
    participants: document.getElementById("participants").value,
    questions: Array.from(document.querySelectorAll(".question-block")).map(block => ({
      reponse: block.querySelector("textarea:nth-of-type(1)").value,
      preuve: block.querySelector("textarea:nth-of-type(2)").value,
      conf: block.querySelector("select").value,
      image: block.querySelector(".dropzone")?.dataset.image || null
    }))
  };
  localStorage.setItem("auditFormData", JSON.stringify(data));
  alert("âœ”ï¸ DonnÃ©es sauvegardÃ©es");
}

function restaurerFormulaire() {
  const saved = localStorage.getItem("auditFormData");
  if (!saved) return alert("âš ï¸ Aucune donnÃ©e sauvegardÃ©e trouvÃ©e.");
  const data = JSON.parse(saved);
  document.getElementById("societe").value = data.societe;
  document.getElementById("adresse").value = data.adresse;
  document.getElementById("participants").value = data.participants;
  const blocks = document.querySelectorAll(".question-block");
  data.questions.forEach((q, i) => {
    if (blocks[i]) {
      blocks[i].querySelector("textarea:nth-of-type(1)").value = q.reponse;
      blocks[i].querySelector("textarea:nth-of-type(2)").value = q.preuve;
      blocks[i].querySelector("select").value = q.conf;
      if (q.image) {
        const drop = blocks[i].querySelector(".dropzone");
        drop.innerHTML = "";
        const img = document.createElement("img");
        img.src = q.image;
        img.style.maxWidth = "100px";
        drop.appendChild(img);
        drop.dataset.image = q.image;
      }
    }
  });
  alert("ğŸ” DonnÃ©es restaurÃ©es");
}
function genererPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  let y = 10;
  doc.setFontSize(14);
  doc.text("Rapport d'Audit â€“ D2F Compliant", 105, y, null, null, "center");
  y += 10;
  doc.setFontSize(10);

  const inputs = document.querySelectorAll('.identite input, .identite textarea');
  inputs.forEach(el => {
    if (el.previousElementSibling) {
      doc.text(`${el.previousElementSibling.innerText} ${el.value}`, 10, y);
      y += 6;
    }
  });

  document.querySelectorAll('.question-block').forEach((block, i) => {
    const titre = block.querySelector('h2')?.innerText;
    const attendu = block.querySelector('.attendu')?.innerText;
    const reponse = block.querySelector('textarea:nth-of-type(1)')?.value;
    const preuve = block.querySelector('textarea:nth-of-type(2)')?.value;
    const conf = block.querySelector('select')?.value;
    const dropzone = block.querySelector('.dropzone');
    const imageData = dropzone?.dataset.image;
    const textData = dropzone?.dataset.text;

    doc.setFont(undefined, 'bold');
    doc.text(titre || `Exigence ${i+1}`, 10, y);
    y += 5;
    doc.setFont(undefined, 'normal');
    const blocAttendu = doc.splitTextToSize(attendu, 180);
    doc.text(blocAttendu, 10, y);
    y += blocAttendu.length * 5;
    y += 3;
    doc.text(doc.splitTextToSize("RÃ©ponse : " + (reponse || ""), 180), 10, y);
    y += 5;
    if (imageData) {
      doc.addImage(imageData, 'JPEG', 10, y, 40, 30);
      y += 35;
    } else if (textData) {
      const blocText = doc.splitTextToSize("ğŸ“‚ Fichier dÃ©posÃ© :
" + textData.slice(0, 500), 180);
      doc.text(blocText, 10, y);
      y += blocText.length * 5;
    } else {
      doc.text("Preuve : (aucune image ou texte)", 10, y);
      y += 5;
    }
    y += 3;
    doc.text(doc.splitTextToSize("ConformitÃ© : " + (conf || ""), 180), 10, y);
    y += 10;
    if (y > 270) { doc.addPage(); y = 10; }
  });
  doc.save("rapport_audit_d2f.pdf");
}

function genererDOCX() {
  const { Document, Packer, Paragraph, TextRun, Media } = window.docx;
  const doc = new Document({
    creator: "D2F Compliant",
    title: "Rapport dâ€™Audit",
    description: "Audit de conformitÃ© fiscal & rÃ©glementaire"
  });
  const content = [];
  content.push(
    new Paragraph({ children: [new TextRun({ text: "Rapport dâ€™Audit â€“ D2F Compliant", bold: true, size: 28 })] }),
    new Paragraph(" "),
    new Paragraph("ğŸ§¾ Nom de la sociÃ©tÃ© : " + document.getElementById("societe").value),
    new Paragraph("ğŸ“ Adresse : " + document.getElementById("adresse").value),
    new Paragraph("ğŸ‘¥ Participants : " + document.getElementById("participants").value),
    new Paragraph("ğŸ“… Date : " + new Date().toLocaleString()),
    new Paragraph(" ")
  );

  document.querySelectorAll(".question-block").forEach((block, i) => {
    const titre = block.querySelector("h2")?.innerText;
    const attendu = block.querySelector(".attendu")?.innerText;
    const reponse = block.querySelector("textarea:nth-of-type(1)")?.value || "";
    const preuve = block.querySelector("textarea:nth-of-type(2)")?.value || "";
    const dropzone = block.querySelector(".dropzone");
    const conf = block.querySelector("select")?.value || "";
    const textData = dropzone?.dataset.text || "";

    content.push(
      new Paragraph({ text: `${i + 1}. ${titre}`, heading: "HEADING_2" }),
      new Paragraph("ğŸ“Œ Attendu : " + attendu),
      new Paragraph("ğŸ–Š RÃ©ponse : " + reponse),
      new Paragraph("ğŸ” Preuve : " + preuve),
      new Paragraph("ğŸ“‚ Fichier dÃ©posÃ© : " + textData),
      new Paragraph("ğŸ” ConformitÃ© : " + conf),
      new Paragraph(" ")
    );
  });

  doc.addSection({ children: content });
  Packer.toBlob(doc).then(blob => {
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "rapport_audit_d2f.docx";
    a.click();
  });
}
</script>
</body>
</html>
