<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Audit de Conformit√© ‚Äì D2F Compliant</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://unpkg.com/docx@8.5.0/build/index.umd.js"></script>
  <script>
    window.addEventListener("DOMContentLoaded", () => {
      if (!window.docx) {
        console.error("‚ùå La biblioth√®que docx.js n'est pas charg√©e correctement.");
      } else {
        console.log("‚úÖ docx.js est charg√© et pr√™t √† l'emploi.");
      }
    });
  </script>
  <style>
    body { font-family: Arial, sans-serif; margin: 2em; background-color: #f9f9f9; }
    h1, h2 { color: #222; }
    label { display: block; margin-top: 1em; font-weight: bold; }
    input, textarea, select {
      width: 100%; padding: 0.5em; margin-top: 0.2em;
      border-radius: 4px; border: 1px solid #bbb;
    }
    button {
      margin-top: 2em; padding: 0.75em 2em; background-color: #0066cc;
      color: white; border: none; border-radius: 4px; cursor: pointer;
    }
    .question-block, .identite {
      background-color: #fff; border-radius: 6px; margin-bottom: 2em;
      padding: 1em; border: 1px solid #ccc;
    }
    .attendu {
      font-size: 0.9em; color: #333; background-color: #eef;
      padding: 0.5em; margin-top: 0.5em; border-left: 4px solid #88a;
    }
  </style>
</head>
<body>
<script>
  const mdpPrompt = (() => {
    const mdp = prompt("üîí Authentification requise\nEntrez le mot de passe d‚Äôacc√®s :");
    if (mdp !== "d2f2024") {
      document.write("<h1 style='color:red'>‚õî Acc√®s refus√©</h1>");
      return false;
    }
    return true;
  })();
  if (!mdpPrompt) throw new Error("Acc√®s refus√©");
</script>

<h1>Audit de Conformit√© ‚Äì D2F Compliant</h1>
<label for="langSwitch">üåê Langue / Language</label>
<select id="langSwitch" onchange="changerLangue(this.value)">
  <option value="fr">Fran√ßais</option>
  <option value="en">English</option>
</select>
<script>
  const lang = localStorage.getItem("langue") || "fr";
  document.getElementById("langSwitch").value = lang;
</script>

<div class="identite">
  <h2>üßæ Informations sur l'entit√© audit√©e</h2>
  <label for="societe">Nom de la soci√©t√©</label>
  <input id="societe">
  <label for="adresse">Adresse</label>
  <input id="adresse">
  <label for="participants">Participants</label>
  <textarea id="participants"></textarea>
</div>
<div id="questionnaire"></div>
<button onclick="genererPDF()">üìÑ Exporter le rapport PDF</button>
<button onclick="genererDOCX()">üìù Exporter le rapport Word</button>
<button onclick="reinitialiserFormulaire()">‚ôªÔ∏è R√©initialiser le formulaire</button>
<p id="msgReset" style="color: green; font-weight: bold;"></p>

<script>
function changerLangue(val) {
  localStorage.setItem('langue', val);
  location.reload();
}

const exigences_traduites = {
  fr: [["Unicit√© des factures", "Chaque facture doit comporter un identifiant unique, non r√©utilisable, chronologique et sans rupture de s√©quence."]],
  en: [["Invoice uniqueness", "Each invoice must have a unique, non-reusable, chronological identifier with no gaps."]]
};

const langues = {
  fr: { conforme: "‚úî Conforme", nonConforme: "‚úò Non Conforme", partiel: "! Partiellement Conforme" },
  en: { conforme: "‚úî Compliant", nonConforme: "‚úò Non-Compliant", partiel: "! Partially Compliant" }
};

const exigences = exigences_traduites[lang];
const qform = document.getElementById("questionnaire");
qform.innerHTML = '';
exigences.forEach((e, i) => {
  const bloc = document.createElement("div");
  bloc.className = "question-block";
  bloc.innerHTML = `<h2>${i + 1}. ${e[0]}</h2>
    <div class="attendu">${e[1]}</div>
    <label>${lang === 'fr' ? 'R√©ponse' : 'Answer'}</label>
    <textarea></textarea>
    <label>${lang === 'fr' ? 'Preuve' : 'Evidence'}</label>
    <div class="dropzone" ondrop="dropImage(event, this)" ondragover="event.preventDefault()" style="border: 2px dashed #aaa; padding: 10px; min-height: 60px; background: #f0f8ff;">${lang === 'fr' ? 'D√©posez ici une image' : 'Drop an image here'}</div>
    <label>${lang === 'fr' ? 'Conformit√©' : 'Compliance'}</label>
    <select>
      <option value="">-- ${lang === 'fr' ? 'Choisir' : 'Select'} --</option>
      <option value="‚úî Conforme">${langues[lang].conforme}</option>
      <option value="‚úò Non Conforme">${langues[lang].nonConforme}</option>
      <option value="! Partiellement Conforme">${langues[lang].partiel}</option>
    </select>`;
  qform.appendChild(bloc);
});
</script>
<script>
async function genererDOCX() {
  const { Document, Packer, Paragraph, TextRun } = window.docx;
  console.log("üì§ D√©but g√©n√©ration DOCX...");

  const doc = new Document();
  const content = [];

  const societe = document.getElementById("societe").value;
  const adresse = document.getElementById("adresse").value;
  const participants = document.getElementById("participants").value;

  content.push(
    new Paragraph({ children: [new TextRun({ text: "Rapport d‚ÄôAudit ‚Äì D2F Compliant", bold: true, size: 28 })] }),
    new Paragraph(" "),
    new Paragraph("üßæ Nom de la soci√©t√© : " + societe),
    new Paragraph("üìç Adresse : " + adresse),
    new Paragraph("üë• Participants : " + participants),
    new Paragraph("üìÖ Date : " + new Date().toLocaleString()),
    new Paragraph(" ")
  );

  document.querySelectorAll(".question-block").forEach((block, i) => {
    const titre = block.querySelector("h2")?.innerText;
    const attendu = block.querySelector(".attendu")?.innerText;
    const reponse = block.querySelector("textarea:nth-of-type(1)")?.value || "";
    const preuve = block.querySelector("textarea:nth-of-type(2)")?.value || "";
    const conf = block.querySelector("select")?.value || "";
    const imageData = block.querySelector(".dropzone")?.dataset.image;

    content.push(
      new Paragraph({ text: `${i + 1}. ${titre}`, heading: "HEADING_2" }),
      new Paragraph("üìå Attendu : " + attendu),
      new Paragraph("üñä R√©ponse : " + reponse),
      new Paragraph("üìé Preuve : " + preuve),
      new Paragraph("üîç Conformit√© : " + conf),
      ...(imageData ? [
        new Paragraph({
          children: [
            new TextRun({ text: "üñºÔ∏è Preuve image :", bold: true }),
          ]
        }),
        new Paragraph({
          children: [
            docx.Media.addImage(doc, base64ToArrayBuffer(imageData.split(',')[1]), 200, 100)
          ]
        })
      ] : []),
      new Paragraph(" ")
    );
  });

  doc.addSection({ children: content });

  function base64ToArrayBuffer(base64) {
    const binary_string = window.atob(base64);
    const len = binary_string.length;
    const bytes = new Uint8Array(len);
    for (let i = 0; i < len; i++) {
      bytes[i] = binary_string.charCodeAt(i);
    }
    return bytes.buffer;
  }

  const blob = await Packer.toBlob(doc);
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "rapport_audit_d2f.docx";
  a.click();
}
function dropImage(event, zone) {
  event.preventDefault();
  const file = event.dataTransfer.files[0];
  if (!file.type.startsWith('image/')) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    zone.innerHTML = `<img src="${e.target.result}" style="max-width:100px;">`;
    zone.dataset.image = e.target.result;
  };
  reader.readAsDataURL(file);
}
</script>
</body>
</html>
