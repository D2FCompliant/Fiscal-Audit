<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Audit de Conformit√© ‚Äì D2F Compliant</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://unpkg.com/docx@8.5.0/build/index.umd.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 2em; background-color: #f9f9f9; }
    h1, h2 { color: #222; }
    label { display: block; margin-top: 1em; font-weight: bold; }
    input, textarea, select {
      width: 100%; padding: 0.5em; margin-top: 0.2em;
      border-radius: 4px; border: 1px solid #bbb;
    }
    button {
      margin-top: 2em; padding: 0.75em 2em; background-color: #0066cc;
      color: white; border: none; border-radius: 4px; cursor: pointer;
    }
    .question-block, .identite {
      background-color: #fff; border-radius: 6px; margin-bottom: 2em;
      padding: 1em; border: 1px solid #ccc;
    }
    .attendu {
      font-size: 0.9em; color: #333; background-color: #eef;
      padding: 0.5em; margin-top: 0.5em; border-left: 4px solid #88a;
    }
  </style>
</head>
<body>
<script>
  const autorise = (() => {
    const mdp = prompt("\ud83d\udd10 Authentification requise\nEntrez le mot de passe d\u2019acc\u00e8s :");
    if (mdp !== "d2f2024") {
      document.write("<h1 style='color:red'>\u26d4 Acc\u00e8s refus\u00e9</h1>");
      return false;
    }
    return true;
  })();
  if (!autorise) throw new Error("Acc\u00e8s refus\u00e9");
</script>

<h1>Audit de Conformit√© ‚Äì D2F Compliant</h1>

<div class="identite">
  <h2>\ud83d\udcce Informations sur l'entit√© audit√©e</h2>
  <label for="societe">Nom de la soci√©t√©</label>
  <input id="societe">
  <label for="adresse">Adresse</label>
  <input id="adresse">
  <label for="participants">Participants</label>
  <textarea id="participants"></textarea>
</div>
<div id="questionnaire"></div>
<button onclick="genererDOCX()">\ud83d\udcdd Exporter le rapport Word</button>

<script>
async function genererDOCX() {
  try {
    const { Document, Packer, Paragraph, TextRun, Media } = window.docx;
    const doc = new Document();
    const content = [];

    const societe = document.getElementById("societe").value || "Non renseign√©";
    const adresse = document.getElementById("adresse").value || "Non renseign√©e";
    const participants = document.getElementById("participants").value || "Non renseign√©s";

    content.push(
      new Paragraph({ children: [new TextRun({ text: "Rapport d‚ÄôAudit ‚Äì D2F Compliant", bold: true, size: 28 })] }),
      new Paragraph(" "),
      new Paragraph("üßæ Nom de la soci√©t√© : " + societe),
      new Paragraph("üìç Adresse : " + adresse),
      new Paragraph("üë• Participants : " + participants),
      new Paragraph("üìÖ Date : " + new Date().toLocaleString()),
      new Paragraph(" ")
    );

    document.querySelectorAll(".question-block").forEach((block, i) => {
      const titre = block.querySelector("h2")?.innerText || `Exigence ${i + 1}`;
      const attendu = block.querySelector(".attendu")?.innerText || "";
      const reponse = block.querySelector("textarea:nth-of-type(1)")?.value || "";
      const preuve = block.querySelector("textarea:nth-of-type(2)")?.value || "";
      const conf = block.querySelector("select")?.value || "";
      const dropzone = block.querySelector(".dropzone");
      const imageData = dropzone?.dataset.image;

      content.push(
        new Paragraph({ children: [new TextRun({ text: `${i + 1}. ${titre}`, bold: true, size: 24 })] }),
        new Paragraph("üìå Attendu : " + attendu),
        new Paragraph("üñä R√©ponse : " + reponse),
        new Paragraph("üîé Preuve : " + preuve),
        new Paragraph("üîç Conformit√© : " + conf)
      );

      if (imageData) {
        const imageBuffer = base64ToArrayBuffer(imageData.split(',')[1]);
        const image = Media.addImage(doc, imageBuffer, 300, 180);
        content.push(new Paragraph(image));
      }

      content.push(new Paragraph(" "));
    });

    doc.addSection({ children: content });

    const blob = await Packer.toBlob(doc);
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "rapport_audit_d2f.docx";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

  } catch (error) {
    alert("‚ùå Une erreur est survenue lors de la g√©n√©ration du fichier Word : " + error.message);
    console.error(error);
  }

  function base64ToArrayBuffer(base64) {
    const binary_string = window.atob(base64);
    const len = binary_string.length;
    const bytes = new Uint8Array(len);
    for (let i = 0; i < len; i++) {
      bytes[i] = binary_string.charCodeAt(i);
    }
    return bytes.buffer;
  }
}
</script>
</body>
</html>
